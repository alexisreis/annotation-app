<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Annotation App</title>
	<link rel="stylesheet"
	      href="https://cdn.jsdelivr.net/npm/@recogito/annotorious@latest/dist/annotorious.min.css">
	<link rel="stylesheet"
	      href="./index.css">
	<script src="https://cdn.jsdelivr.net/npm/@recogito/annotorious@latest/dist/annotorious.min.js"></script>
	<script src="sense-widget.js"></script>
	<script src="transcription-widget.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-better-polygon@latest/dist/annotorious-better-polygon.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@recogito/annotorious-toolbar@latest/dist/annotorious-toolbar.min.js"></script>
</head>
<body>
<input type="file" onchange="upload()" id="file"/>
<br/>
<div id="options-container"></div>
<br/>
<div id="my-toolbar-container"></div>
<img id="my-image" width="100%"/>

<script type="text/javascript">

	let isImproved = false;
	let showIsOriginal = true;
	let originalImage;
	let improvedImage;
	let imageName = "";
	let annotations = [];
	let anno;

	const getLocalAnnotations = () => {
		return localStorage.getItem(imageName)
	}

	const setLocalAnnotation = (newAnnotations) => {
		localStorage.setItem(imageName, JSON.stringify(newAnnotations))
	}

	const SenseFormatter = function (annotation) {
		//TODO améliorer algos
		const isVue = annotation.bodies.find(b => {
			return b.purpose === 'sense' && b.value['Vue']
		});

		const isSon = annotation.bodies.find(b => {
			return b.purpose === 'sense' && b.value['Son']
		});

		const isGout = annotation.bodies.find(b => {
			return b.purpose === 'sense' && b.value['Gout']
		});

		const isOdeur = annotation.bodies.find(b => {
			return b.purpose === 'sense' && b.value['Odeur']
		});

		const isToucher = annotation.bodies.find(b => {
			return b.purpose === 'sense' && b.value['Toucher']
		});
		// add the important css class if the tag is present
		if (isVue) return 'vue'
		if (isSon) return 'son'
		if (isGout) return 'gout'
		if (isOdeur) return 'odeur'
		if (isToucher) return 'toucher'
	}

	const TranscriptionFormatter = function (annotation) {
		// Find the label body (if any)
		const label = annotation.bodies.find(b => b.purpose === 'transcription');

		if (label) {
			// Return an HTML label, wrapped in an SVG foreignObject
			const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
			foreignObject.innerHTML =
				`<label xmlns="http://www.w3.org/1999/xhtml" >${label.value}</label>`;

			return {
				element: foreignObject
			};
		}
	}

	function initAnnotorious() {
		anno = Annotorious.init({
			image: 'my-image',
			widgets: [
				recogito.SenseWidget,
				recogito.TranscriptionWidget,
				/*'COMMENT',
				 {
				 widget: 'TAG', vocabulary: ['Vue', 'Son', 'Gout', 'Toucher',
				 'Odeur']
				 }*/
			],
			formatters: [SenseFormatter, TranscriptionFormatter]
		});

		Annotorious.BetterPolygon(anno);
		anno.setDrawingTool('polygon');
		Annotorious.Toolbar(anno, document.getElementById('my-toolbar-container'));


		const storedAnnotation = getLocalAnnotations();
		if (storedAnnotation) {
			// console.log('storedAnnotations', storedAnnotation)
			const theannotations = window.JSON.parse(storedAnnotation)
			annotations = theannotations;
			anno.setAnnotations(annotations);
		}

		anno.on('createAnnotation', (annotation) => {
			annotations = [...annotations, annotation]
			setLocalAnnotation(annotations)
		});

		anno.on('updateAnnotation', (annotation, previous) => {
			const newAnnotations = annotations.map(val => {
				if (val.id === annotation.id) return annotation
				return val
			})
			annotations = newAnnotations;
			setLocalAnnotation(annotations);
		});

		anno.on('deleteAnnotation', (annotation) => {
			const newAnnotations = annotations.filter(val => val.id !== annotation.id)
			annotations = newAnnotations;
			setLocalAnnotation(annotations);
		});

		document.getElementById("options-container").innerHTML =
			"<button onClick='improveImage()'>Améliorer l'image</button> " +
			"<button onClick='saveAnnotationsToJSON()'>Exporter JSON</button>";
	}

	function upload() {

		isImproved = false;
		if (anno) {
			var toolbar = document.getElementsByClassName('a9s-toolbar')[0];
			toolbar.parentNode.removeChild(toolbar);
			anno.destroy()
		}

		const file = document.getElementById('file').files[0];
		imageName = file.name;

		const reader = new FileReader();
		reader.onload = function (e) {
			const image = document.getElementById("my-image");
			image.src = e.target.result;
			originalImage = e.target.result;
		}

		reader.readAsDataURL(file);
		showIsOriginal = true;

		initAnnotorious()
	}

	async function improveImage() {
		if (!isImproved) {
			// Create a FormData to POST to backend
			const formData = new FormData();
			formData.append("file", document.getElementById('file').files[0]);

			const response = await fetch(`http://localhost:5000/uploadImage`, {
				method: 'POST',
				body: formData,
				contentType: false,
				processData: false
			})

			const blob = await response.blob()
			improvedImage = URL.createObjectURL(blob)
			document.getElementById("my-image").src = improvedImage;
			isImproved = true;
			showIsOriginal = false;
		} else {
			returnToBase()
		}
	}

	function returnToBase() {
		if (showIsOriginal) {
			document.getElementById("my-image").src =
				improvedImage;
		} else {
			document.getElementById("my-image").src =
				originalImage;
		}
		showIsOriginal = !showIsOriginal;
	}

	function download(content, fileName, contentType) {
		var a = document.createElement("a");
		var file = new Blob([JSON.stringify(content, null, 2)], {
			type:
			contentType
		});
		a.href = URL.createObjectURL(file);
		a.download = fileName;
		a.click();
	}

	function saveAnnotationsToJSON() {
		download(anno.getAnnotations(), `${imageName}.json`, 'text/plain');
	}
</script>
</body>
</html>